From 3fa166607416d80ffceba70b8f53a46a6e32f3a4 Mon Sep 17 00:00:00 2001
From: Maxime Vidori <maxime.vidori@gmail.com>
Date: Sun, 8 Jan 2017 13:42:41 +0100
Subject: [PATCH 1/3] Add pxe profile

---
 alpine-pxe.conf.mk  | 4 ++++
 alpine-pxe.packages | 0
 2 files changed, 4 insertions(+)
 create mode 100644 alpine-pxe.conf.mk
 create mode 100644 alpine-pxe.packages

diff --git a/alpine-pxe.conf.mk b/alpine-pxe.conf.mk
new file mode 100644
index 0000000..e0d46b8
--- /dev/null
+++ b/alpine-pxe.conf.mk
@@ -0,0 +1,4 @@
+ALPINE_NAME   := alpine-pxe
+KERNEL_FLAVOR := grsec
+INITFS_FEATURES := ata base bootchart squashfs ext4 network dhcp scsi
+MODLOOP_EXTRA :=
diff --git a/alpine-pxe.packages b/alpine-pxe.packages
new file mode 100644
index 0000000..e69de29
-- 
2.1.4


From e0ac9ff9ba8f666af8b782f6b4975f7a741c8359 Mon Sep 17 00:00:00 2001
From: Maxime Vidori <maxime.vidori@gmail.com>
Date: Fri, 3 Feb 2017 13:34:10 +0100
Subject: [PATCH 2/3] Add a possibility to configure the init script

When building a new iso the init script included in the initramfs is the
default one and cannot be configured.
This patch introduce an INITFS_SCRIPT which is configurable with a custom
script location, or if not provided take the default one in
/usr/share/mkinitfs/initramfs-init
---
 Makefile | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/Makefile b/Makefile
index f88a6a9..e25d395 100755
--- a/Makefile
+++ b/Makefile
@@ -128,6 +128,7 @@ INITFS_TMP	= $(DESTDIR)/tmp.initfs.$*
 INITFS_DIRSTAMP := $(DESTDIR)/stamp.initfs.%
 INITFS_FEATURES	?= ata base bootchart cdrom squashfs ext2 ext3 ext4 mmc raid scsi usb virtio
 INITFS_PKGS	= $(MODLOOP_PKGS) alpine-base acct mdadm
+INITFS_SCRIPT ?= /usr/share/mkinitfs/initramfs-init
 
 initfs-%: $(INITFS)
 	@:
@@ -152,9 +153,9 @@ $(INITFS_DIRSTAMP):
 	fi
 	@touch $@
 
-$(INITFS): $(INITFS_DIRSTAMP) $(MODLOOP_DIRSTAMP)
-	@mkinitfs -F "$(INITFS_FEATURES)" -t $(INITFS_TMP) \
-		-b $(INITFS_DIR) -o $@ $(MODLOOP_KERNEL_RELEASE)
+$(INITFS): $(INITFS_DIRSTAMP) $(MODLOOP_DIRSTAMP) $(INITFS_SCRIPT)
+	mkinitfs -F "$(INITFS_FEATURES)" -t $(INITFS_TMP) \
+		-b $(INITFS_DIR) -o $@ -i $(INITFS_SCRIPT) $(MODLOOP_KERNEL_RELEASE)
 
 clean-initfs-%:
 	@rm -rf $(subst %,$*,$(INITFS) $(INITFS_DIRSTAMP)) $(INITFS_DIR)
-- 
2.1.4


From ee3ee557dd8618a1f84f2268c1f8edd0278c45d8 Mon Sep 17 00:00:00 2001
From: Maxime Vidori <maxime.vidori@gmail.com>
Date: Thu, 9 Feb 2017 18:41:59 +0100
Subject: [PATCH 3/3] Add a custom init script

---
 init.sh | 49 +++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 49 insertions(+)
 create mode 100644 init.sh

diff --git a/init.sh b/init.sh
new file mode 100644
index 0000000..ab7d032
--- /dev/null
+++ b/init.sh
@@ -0,0 +1,49 @@
+#!/bin/sh
+
+/bin/busybox mkdir -p /usr/bin /usr/sbin /proc /sys /dev /media/cdrom \
+	/media/usb /tmp
+/bin/busybox --install -s
+
+# basic environment
+export PATH=/usr/bin:/bin:/usr/sbin:/sbin
+
+# needed devs
+[ -c /dev/null ] || mknod -m 666 /dev/null c 1 3
+
+# basic mounts
+mount -t proc -o noexec,nosuid,nodev proc /proc
+mount -t sysfs -o noexec,nosuid,nodev sysfs /sys
+
+mount -t tmpfs -o exec,nosuid,mode=0755,size=1M mdev /dev
+echo "/sbin/mdev" > /proc/sys/kernel/hotplug
+mdev -s
+[ -d /dev/pts ] || mkdir -m 755 /dev/pts
+[ -c /dev/ptmx ] || mknod -m 666 /dev/ptmx c 5 2
+# make sure /dev/null is setup correctly
+[ -f /dev/null ] && rm -f /dev/null
+[ -c /dev/null ] || mknod -m 666 /dev/null c 1 3
+mount -t devpts -o gid=5,mode=0620,noexec,nosuid devpts /dev/pts
+[ -d /dev/shm ] || mkdir /dev/shm
+mount -t tmpfs -o nodev,nosuid,noexec shm /dev/shm
+
+# activate kernel modules and drivers
+modprobe -a loop squashfs sd_mod 2> /dev/null
+find /sys -name modalias | xargs sort -u | xargs modprobe -a 2> /dev/null
+find /sys -name modalias | xargs sort -u | xargs modprobe -a 2> /dev/null
+
+#Â configure network
+for x in /sys/class/net/eth*
+do
+	echo $x
+	[ -e "$x" ] && device=${x##*/} && break
+done
+if [ -z "$device" ]
+then
+	echo "ERROR: IP requested but no network device was found"
+	exit 1
+fi
+echo "Obtaining IP via DHCP ($device)..."
+ifconfig $device 0.0.0.0
+udhcpc -i $device -f -q
+
+exec /bin/busybox sh
-- 
2.1.4

